### Project Design Document

#### Metadata

- **Project Name**: SmolURL
- **Author(s)**: nn-advith
- **Created On**: 19-04-2025
- **Last Updated**: 23-04-2025
- **Version**: 0.0.1

---

#### Overview

SmolURL is a simple url shortner application, that shortens a given url and returns the new url.

---

#### Architecture

##### High-Level Design

![Architecture](./assets/scuffed.png)

SmolURL consists of three main modules: Application module, Hash Module and the KV Module. The client interacts with the application module (a web server) for generating the short urls and visiting the short urls. The application module interacts with the other modules ( and utility modules like the Logger ) to service the type of request from the client. The hashing module is used to generate the short url from the long url. The KV module handles the interactions with the database such as storage and retreival. Couchbase is the actual KV store ( Key-Document store would be more apt) with a simple schema enforced in the application level. The logger logs.

##### Component Breakdown

| Component          | Responsibility                         | Tech Stack | Notes |
| ------------------ | -------------------------------------- | ---------- | ----- |
| Logger             | Logging utility; file and stdout       | Go         |       |
| K-V Store          | Key-document store for the hashed urls | Couchbase  |       |
| KV Module          | Module to handle storage and retreival | Go         |       |
| Hash Module        | Generates short url from long url      | Go         |       |
| Application Module | Client-facing webserver; handles input | Go         |       |

##### Component Design

###### **Logger:**

Singleton design to enable usage form any module. Will be able to write logs to stdout and a log file, located at `%APPDATA%/smolurl/logs` on Windows and `~/.config/smolurl/logs/` on Linux. Can be controlled. Logger type is a struct with signature

```
type Logger struct {
    filelog     bool
    stdlog      bool
    logfilepath string
    logfile     *os.File
    logger      *log.Logger
}

Logger.Info(msg ...any)
Logger.Error(msg ...any)
Logger.Fatal(msg ...any)

```

###### **KV-Module:**

---

#### Data Model / Storage

The storage datamodel is a simple key-document model

```
"short-url-hash": {
    "longurl": "long-url value"
    "created": <timestamp in seconds>
    "ttl": <time in seconds>
}
```

The `short-url-hash` acts as the index for retreival operations. This schema is enforced in the application level.

Couchbase will be the choice of storage under bucket `SMOLURL`, scope `_default`, collection `urls`. Secure access to couchbase to be maintained with the help of users with only bucket level access.

**Application level struct**:

```
type shortURL struct {
    longurl string `json:"longurl"`
    created int64 `json:"created"`
    ttl int `json:"ttl"`
}
```

---

#### API endpoints

| Method | Input                         | Output                                                      | Description                |
| ------ | ----------------------------- | ----------------------------------------------------------- | -------------------------- |
| POST   | body -> some long url         | 200 OK; smol url payload                                    | Generate URL from long url |
| GET    | smolurl hash as URL parameter | if valid -> 301 redirect to long url ;else -> 404 not found | Visit smolurl hash         |

---

#### Dependencies

- Couchbase - 7.6.5-5704

---

#### Failure Handling

| Failure case   | Description             | Handler                   |
| -------------- | ----------------------- | ------------------------- |
| Invalid input  | Malformed link          | 400 Bad Request           |
| Database down  | ehhh                    | 500 Internal Server Error |
| Hash collision | shorturl already exists | Retry                     |
| Expired url    | ttl passed              | 410 Done                  |

Log failures in file if necessary

---

#### Testing Plan

**Unit Tests**

Each function in the modules to be tested with simulated inputs. <u>To be updated</u>.

**Functional Tests**

Each feature to be tested for functionality; both positive and negative cases. <u>To be updated</u>.

---

#### Future Work

- Couchbase is not the ideal database for this application. It works but something like Redis is much more suited. Develop a module which allows utilisation of redis as a dataabase without breaking the existing couchbase implementation.

---

#### Appendix

1. [Couchbase N1QL cheat sheet](https://docs.couchbase.com/files/Couchbase-N1QL-CheatSheet.pdf)
